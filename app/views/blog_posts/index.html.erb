<h1>BlogPosts#index</h1>

<% if current_user && policy(BlogPost).create? %>
  <p><%= link_to 'New Blog Post', new_blog_post_path %></p>
<% else %>
  <p><%= link_to 'Log in to create a new blog post', new_user_session_path %> </p>
<% end %>

<% @blog_posts.order_by_updated.each do |blog_post| %>
  <%#= link_to blog_post_path(blog_post) do  %>
    <div class="card p-3">
      <h3><%= blog_post.title %></h3>
      <p>Posted by: <%= blog_post.user.gametag %></p>
      <p class="textToAutoLink"><%= blog_post.content %></p>

      <% if blog_post.content.match(/\bhttp.+\.gif\b/) %>
        <div class="gif m-3 p-3">
          <%= image_tag blog_post.content.match(/\bhttp.+\.gif\b/)[0], width: 200, alt: "A GIF" %>
        </div>
      <% end %>

      <% if blog_post.blog_image.attached? %>
        <div class="gif m-3 p-3">
          <% if blog_post.blog_image.blob.image? %>
            <%= cl_image_tag blog_post.blog_image.key, width: 150 %>
          <% elsif blog_post.blog_image.blob.video? %>
            <%= cl_video_tag blog_post.blog_image.key, width: 200, height: 150, crop: :pad, controls: true %>
          <% end %>
        </div>
      <% end %>

      <ul>
        <% if current_user %>
          <% if policy(blog_post).edit? %>
            <li>
              <%= link_to 'Edit', edit_blog_post_path(blog_post) %>
            </li>
          <% end %>
          <% if policy(blog_post).destroy? %>
            <li>
              <%= link_to 'Delete', blog_post_path(blog_post),
                method: 'delete',
                data: { confirm: "Are you sure you want to delete #{blog_post.title}?" }
              %>
            </li>
          <% end %>
          <li>
            <%= link_to blog_like_path(blog_post) do %>
              <% pre_like = blog_post.blog_likes.find { |like| like.user_id == current_user.id} %>
              <% if pre_like %>
                <i class="far fa-thumbs-down"></i>
              <% else %>
                <i class="far fa-thumbs-up"></i>
              <% end %>
            <% end %>
            <%= blog_post.blog_likes.count %>
            <%= blog_post.blog_likes.count == 1 ? 'Like' : 'Likes' %>
          </li>

        <% else %>
          <li>
            <%= blog_post.blog_likes.count %>
            <%= blog_post.blog_likes.count == 1 ? 'Like' : 'Likes' %>
          </li>
        <% end %>
      </ul>
    </div>
  <%# end %>
<% end %>
